<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <title>Oke Seduh - Keranjang Belanja</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f9f7f5; color: #3e2723; padding-top: 70px; }
        .navbar { position: fixed; top: 0; left: 0; width: 100%; background-color: rgba(62, 39, 35, 0.95); color: white; display: flex; align-items: center; justify-content: flex-end; padding: 10px 25px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-links { display: flex; align-items: center; gap: 10px; }
        .nav-button { background: none; border: none; color: white; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 1rem; text-decoration: none; border-radius: 5px; position: relative; transition: background-color 0.3s ease; }
        .nav-button:hover { background-color: rgba(255, 255, 255, 0.2); }
        .nav-button.active { background-color: rgba(255, 255, 255, 0.15); }
        .cart-count-badge { position: absolute; top: 2px; right: 2px; background-color: #e53935; color: white; border-radius: 50%; padding: 1px 6px; font-size: 0.7rem; min-width: 18px; text-align: center; display: none; }
        .user-icon { font-size: 1.4rem; line-height: 1; display: inline-block; vertical-align: middle; }
        .cart-container { max-width: 850px; margin: 30px auto 40px auto; padding: 25px 30px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); min-height: 300px; display: flex; flex-direction: column; }
        .cart-container h2 { text-align: center; margin-bottom: 30px; font-size: 2rem; color: #3e2723; }
        .cart-items { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; background: #fdfaf8; border: 1px solid #eee; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .cart-item-info { flex-grow: 1; display: flex; align-items: center; }
        .cart-item-info img { width: 75px; height: 75px; object-fit: cover; border-radius: 6px; margin-right: 20px; }
        .item-details h4 { margin: 0 0 5px 0; color: #4e342e; font-size: 1.15rem; }
        .item-details .price-per-item { color: #757575; font-size: 0.9rem; }
        .cart-item-controls { display: flex; align-items: center; gap: 10px; margin-left: 15px; }
        .quantity-control { display: flex; align-items: center; gap: 8px; }
        .quantity-control button { background-color: #6d4c41; color: white; border: none; border-radius: 4px; width: 30px; height: 30px; font-size: 1.2rem; cursor: pointer; transition: background-color 0.2s; }
        .quantity-control span.quantity { min-width: 25px; text-align: center; font-weight: bold; font-size: 1rem; }
        .item-total-price { font-weight: bold; color: #3e2723; font-size: 1.1rem; min-width: 90px; text-align: right; }
        .remove-item-btn { background-color: #e57373; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; }
        .cart-summary { border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 25px; display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: bold; }
        .checkout-button { display: block; width: 100%; padding: 15px; background-color: #5d4037; color: white; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 30px; }
        .empty-cart-message { text-align: center; color: #757575; font-size: 1.1rem; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .empty-cart-message a { color:#6d4c41; text-decoration: underline; margin-left: 5px; }
    </style>
</head>
<body>

    <header class="navbar" id="navbar-header">
        <nav class="nav-links">
            <a th:href="@{/index}" class="nav-button">BERANDA</a>
            <a th:href="@{/login}" class="nav-button" sec:authorize="isAnonymous()">LOGIN</a>
            <a th:href="@{/admin/menu/manage}" class="nav-button" sec:authorize="hasRole('ADMIN')">PANEL ADMIN</a>
            <a th:href="@{/profile}" class="nav-button" sec:authorize="isAuthenticated()" title="Profil"><span class="user-icon">&#128100;</span></a>
            <form th:action="@{/logout}" method="post" style="margin:0; display:inline;" sec:authorize="isAuthenticated()">
                <button type="submit" class="nav-button" title="Logout"><span class="user-icon">&#10162;</span></button>
            </form>
            <a th:href="@{/cart}" class="nav-button active">
                KERANJANG
                <span class="cart-count-badge" id="cartCountBadge" th:text="${cartItemCount ?: 0}" th:style="${cartItemCount == null || cartItemCount == 0 ? 'display:none;' : 'display:inline-block;'}">0</span>
            </a>
        </nav>
    </header>

    <main class="cart-container">
        <h2>Keranjang Belanja Anda</h2>

        <div th:if="${cart == null or #lists.isEmpty(cart.items)}" class="empty-cart-message">
            Keranjang Anda kosong. Yuk, tambahkan item dari <a th:href="@{/index#menu}">menu</a>!
        </div>

        <div th:if="${cart != null and not #lists.isEmpty(cart.items)}">
            <div class="cart-items" id="cartItemsContainer">
                <div class="cart-item" th:each="cartItem : ${cart.items}" th:attr="data-itemid=${cartItem.menuItem.id}">
                    <div class="cart-item-info">
                        <img th:src="${cartItem.menuItem.imageUrl}" th:alt="${cartItem.menuItem.name}" onerror="this.style.display='none'"/>
                        <div class="item-details">
                            <h4 th:text="${cartItem.menuItem.name}">Nama Item</h4>
                            <span class="price-per-item" th:text="${#numbers.formatCurrency(cartItem.menuItem.price)} + '/item'">RpXX.XXX/item</span>
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-control">
                            <button class="decrement-cart-item" th:attr="data-itemid=${cartItem.menuItem.id}">âˆ’</button>
                            <span class="quantity" th:text="${cartItem.quantity}">1</span>
                            <button class="increment-cart-item" th:attr="data-itemid=${cartItem.menuItem.id}">+</button>
                        </div>
                        <span class="item-total-price" th:text="${#numbers.formatCurrency(cartItem.menuItem.price * cartItem.quantity)}">RpXX.XXX</span>
                        <button class="remove-item-btn" th:attr="data-itemid=${cartItem.menuItem.id}">Hapus</button>
                    </div>
                </div>
            </div>

            <div class="cart-summary" id="cartSummarySection">
                <span>Total Belanja:</span>
                <span id="grandTotal" th:text="${#numbers.formatCurrency(grandTotal)}">Rp0</span>
            </div>

            <button class="checkout-button" id="checkoutButton">Lanjutkan ke Pembayaran</button>
        </div>
    </main>

    <script>
        // Fungsi global untuk mendapatkan CSRF token
        function getCsrfToken() {
            const token = document.querySelector('meta[name="_csrf"]');
            const header = document.querySelector('meta[name="_csrf_header"]');
            if (token && header) {
                return { headerName: header.content, token: token.content };
            }
            return null;
        }

        // Fungsi untuk mengirim update ke server via AJAX
        async function updateCart(menuItemId, newQuantity) {
            const csrf = getCsrfToken();
            const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
            if (csrf) { headers[csrf.headerName] = csrf.token; }

            try {
                const response = await fetch('/cart/update', {
                    method: 'POST',
                    headers: headers,
                    body: new URLSearchParams({ 'menuItemId': menuItemId, 'quantity': newQuantity })
                });

                if (response.ok) {
                    window.location.reload(); // Cara paling mudah untuk refresh halaman
                } else {
                    const errorResult = await response.json();
                    alert('Error: ' + (errorResult.error || 'Gagal memperbarui keranjang.'));
                }
            } catch (error) {
                 console.error("Error saat update keranjang:", error);
                 alert("Terjadi kesalahan pada jaringan atau server.");
            }
        }

        // Pasang event listener ke seluruh kontainer item keranjang (Event Delegation)
        document.addEventListener('DOMContentLoaded', () => {
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            if (cartItemsContainer) {
                cartItemsContainer.addEventListener('click', function(event) {
                    const target = event.target;
                    const menuItemId = target.dataset.itemid;
                    if (!menuItemId) return; // Klik bukan pada tombol yang relevan

                    const quantitySpan = target.closest('.quantity-control')?.querySelector('.quantity');
                    let currentQty = quantitySpan ? parseInt(quantitySpan.textContent) : 0;
                    
                    if (target.classList.contains('increment-cart-item')) {
                        updateCart(menuItemId, currentQty + 1);
                    } else if (target.classList.contains('decrement-cart-item')) {
                        if (currentQty > 0) {
                            updateCart(menuItemId, currentQty - 1);
                        }
                    } else if (target.classList.contains('remove-item-btn')) {
                        if (confirm('Anda yakin ingin menghapus item ini dari keranjang?')) {
                            updateCart(menuItemId, 0); // Kirim kuantitas 0 untuk menghapus
                        }
                    }
                });
            }

            // Event listener untuk tombol checkout
            const checkoutBtn = document.getElementById('checkoutButton');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', () => {
                    alert('Proses checkout belum diimplementasikan.');
                });
            }
        });
    </script>
</body>
</html>